<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Radio</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin: 24px;
        }

        .card {
            max-width: 520px;
            padding: 18px;
            border: 1px solid #ddd;
            border-radius: 14px;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        button {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }

        .time {
            margin-left: auto;
            opacity: .7;
            font-variant-numeric: tabular-nums;
        }

        .title {
            margin-top: 12px;
            font-size: 18px;
            font-weight: 650;
        }

        .meta {
            margin-top: 6px;
            opacity: .7;
        }

        .small {
            margin-top: 10px;
            font-size: 12px;
            opacity: .6;
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="row">
            <button id="toggle">▶︎ Play</button>
            <div class="time" id="clock">--:--:--</div>
        </div>

        <div class="title" id="nowTitle">—</div>
        <div class="meta" id="nowMeta">Chargement des métadonnées…</div>
        <div class="small" id="debug"></div>

        <audio id="audio" preload="none" crossorigin="anonymous">
            <source src="https://radio.choucroute.club/live.mp3" type="audio/mpeg" />
        </audio>
    </div>

    <script>
        const audio = document.getElementById("audio");
        const btn = document.getElementById("toggle");
        const clockEl = document.getElementById("clock");
        const nowTitle = document.getElementById("nowTitle");
        const nowMeta = document.getElementById("nowMeta");
        const debugEl = document.getElementById("debug");

        // --- Horloge ---
        function tick() {
            const d = new Date();
            const hh = String(d.getHours()).padStart(2, "0");
            const mm = String(d.getMinutes()).padStart(2, "0");
            const ss = String(d.getSeconds()).padStart(2, "0");
            clockEl.textContent = `${hh}:${mm}:${ss}`;
        }
        tick(); setInterval(tick, 1000);

        // --- Play / Pause ---
        btn.addEventListener("click", async () => {
            try {
                if (audio.paused) {
                    await audio.play();
                    btn.textContent = "❚❚ Pause";
                } else {
                    audio.pause();
                    btn.textContent = "▶︎ Play";
                }
            } catch (e) {
                nowMeta.textContent = "Impossible de lancer le stream (autoplay / réseau). Clique encore ou check la console.";
            }
        });

        // --- Récupération métadonnées Icecast ---
        // IMPORTANT: si CORS bloque, lis la section 2)
        const STATUS_URL = "https://radio.choucroute.club/status-json.xsl";

        function pickSource(icestats) {
            // icestats.source peut être un objet ou un tableau
            const s = icestats?.source;
            if (!s) return null;
            const sources = Array.isArray(s) ? s : [s];

            // Si plusieurs mounts, on essaie de prendre celui qui correspond à /live
            return sources.find(x => x.listenurl?.includes("/live")) || sources[0];
        }

        function fixMojibake(s) {
            if (!s) return s;
            // Heuristique: si ça contient Ã/Â, c'est souvent de l'UTF-8 mal décodé
            if (!/[ÃÂ]/.test(s)) return s;
            try {
                const bytes = Uint8Array.from([...s].map(ch => ch.charCodeAt(0) & 0xff));
                return new TextDecoder("utf-8").decode(bytes);
            } catch {
                return s;
            }
        }


        function formatNowPlaying(src) {
            // Selon config, ça peut être "title" ou parfois "artist"/"song" etc.
            const raw = fixMojibake((src?.title || src?.yp_currently_playing || "")).trim();
            if (!raw) return { title: "—", meta: "Aucun titre transmis (Liquidsoap/Icecast)" };

            // tentative split "Artist - Track"
            const parts = raw.split(" - ");
            if (parts.length >= 2) {
                return { title: parts.slice(1).join(" - "), meta: parts[0] };
            }
            return { title: raw, meta: src?.server_name ? `Sur ${src.server_name}` : "En direct" };
        }

        async function loadMeta() {
            const res = await fetch(STATUS_URL, { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();

            const src = pickSource(data?.icestats);
            if (!src) {
                nowTitle.textContent = "—";
                nowMeta.textContent = "Impossible de lire icestats.source";
                return;
            }

            const np = formatNowPlaying(src);
            nowTitle.textContent = np.title;
            nowMeta.textContent = np.meta;

            // debug optionnel
            debugEl.textContent = `Listeners: ${src.listeners ?? "?"} · Bitrate: ${src.bitrate ?? "?"}kbps`;
        }

        async function poll() {
            try {
                await loadMeta();
            } catch (e) {
                nowMeta.textContent = "Métadonnées indisponibles (CORS / endpoint / Icecast).";
                debugEl.textContent = String(e);
            }
        }

        poll();
        setInterval(poll, 5000); // toutes les 5s
    </script>
</body>

</html>